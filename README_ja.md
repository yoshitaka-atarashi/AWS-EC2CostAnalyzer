# AWS EC2 コスト最適化アナライザー

[![Python 3.7+](https://img.shields.io/badge/python-3.7+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Platform: Windows](https://img.shields.io/badge/platform-Windows-lightgrey.svg)](https://www.microsoft.com/windows)

AWS EC2インスタンスの使用パターン、コスト、リソース使用率を分析してコスト最適化の機会を特定する包括的なPythonツールです。

> 🇺🇸 **English Version**: See [README.md](README.md)

## 🚀 機能

- **スマートコスト分析**: 最適化機会の2段階優先度システム
- **包括的監視**: CPU使用率とネットワーク活動の分析
- **コスト計算**: リアルタイムコスト見積もりと潜在的節約額
- **簡単セットアップ**: バッチスクリプトによる自動Python環境構築
- **柔軟なレポート**: コンソール出力とJSON出力オプション
- **マルチリージョン対応**: 異なるAWSリージョンでのインスタンス分析

### 分析優先度

1. **🚨 高優先度**: 高額インスタンス（月額$100以上）で24時間以上稼働
2. **⚠️ 中優先度**: 長期間稼働インスタンス（30日以上）

## 📋 目次

- [前提条件](#前提条件)
- [クイックスタート](#クイックスタート)
- [使用方法](#使用方法)
- [設定](#設定)
- [出力例](#出力例)
- [分析基準](#分析基準)
- [トラブルシューティング](#トラブルシューティング)
- [貢献](#貢献)
- [ライセンス](#ライセンス)

> 📖 **詳細なインストールガイド**: [docs/INSTALLATION_ja.md](docs/INSTALLATION_ja.md)

## 📋 前提条件

### システム要件
- **Windows 10/11**（Windows Serverもサポート）
- **Python 3.7+**（必要に応じて自動検出・インストール）
- **AWS CLI**（オプション、環境変数も使用可能）

### AWS要件
- EC2インスタンスを持つ**AWSアカウント**
- **IAM権限**:
  - `ec2:DescribeInstances`
  - `cloudwatch:GetMetricStatistics`

### AWS認証（いずれかの方法を選択）

#### 方法1: AWS CLI
```cmd
aws configure
```

#### 方法2: 環境変数
```cmd
set AWS_ACCESS_KEY_ID=your_access_key
set AWS_SECRET_ACCESS_KEY=your_secret_key
set AWS_DEFAULT_REGION=ap-northeast-1
```

#### 方法3: IAMロール（EC2インスタンス用）
必要な権限を持つIAMロールをEC2インスタンスにアタッチします。

## 🚀 クイックスタート

### ワンコマンドセットアップ（推奨）
```cmd
start.bat
```
このコマンド一つで以下が実行されます：
- Pythonの自動検出（見つからない場合はインストールガイダンス）
- 仮想環境の自動作成
- 必要なパッケージのインストール
- 実行オプションメニューの表示

### 手動セットアップ（代替方法）

#### ステップ1: Pythonのインストール（必要な場合）
```cmd
install_python.bat
```
*Python自動インストールには管理者権限で実行*

#### ステップ2: 環境セットアップ
```cmd
setup.bat
```
仮想環境を作成し、依存関係をインストールします

## 💻 使用方法

### 基本実行
```cmd
run.bat
```

### 高度なオプション
```cmd
# 特定のリージョンを分析
run.bat --region us-west-2

# 分析期間を変更（過去7日間）
run.bat --days 7

# CPU閾値を調整（10%未満の使用率を対象）
run.bat --cpu-threshold 10.0

# 高額インスタンス閾値を設定（月額$200以上）
run.bat --expensive-threshold 200.0

# 結果をJSONにエクスポート
run.bat --output cost_analysis.json

# オプション組み合わせ
run.bat --region ap-northeast-1 --days 14 --cpu-threshold 3.0 --expensive-threshold 150.0 --output report.json
```

### 対話モード
```cmd
run_with_options.bat
```
*すべてのオプションを設定するメニュー駆動インターフェース*

### クリーンアップ
```cmd
clean.bat
```
*仮想環境を削除*

## 📁 プロジェクト構造

```
aws-ec2-cost-analyzer/
├── 📄 ec2_usage_analyzer.py    # メイン分析スクリプト
├── 📄 requirements.txt         # Python依存関係
├── 🚀 start.bat               # ワンコマンドスタートアップ
├── ⚙️ setup.bat               # 環境セットアップ
├── ▶️ run.bat                 # 基本実行
├── 🎛️ run_with_options.bat    # 対話式実行
├── 🐍 install_python.bat      # Pythonインストーラー
├── 🧹 clean.bat               # クリーンアップユーティリティ
└── 📖 README.md               # このファイル
```

## ⚙️ 設定

### コマンドラインオプション

| オプション | デフォルト | 説明 |
|-----------|-----------|------|
| `--region` | `ap-northeast-1` | 分析するAWSリージョン |
| `--days` | `30` | 分析期間（日数） |
| `--cpu-threshold` | `5.0` | CPU使用率閾値（%） |
| `--expensive-threshold` | `100.0` | 高額インスタンス閾値（$/月） |
| `--output` | なし | JSON出力ファイルパス |

### Python直接実行

Pythonを直接実行したい場合：

```bash
# 基本使用法
python ec2_usage_analyzer.py

# オプション付き
python ec2_usage_analyzer.py --region us-west-2 --days 7 --cpu-threshold 10.0

# 完全設定
python ec2_usage_analyzer.py --region ap-northeast-1 --days 14 --cpu-threshold 3.0 --expensive-threshold 150.0 --output report.json
```

## 📊 出力例

```
🚀 AWS EC2コスト最適化分析を開始します
📍 リージョン: ap-northeast-1
📅 分析期間: 過去30日間
🎯 CPU閾値: 5.0%
💰 高額インスタンス閾値: $100/月

================================================================================
🔍 AWS EC2コスト最適化分析
================================================================================
📅 分析期間: 過去30日間
🎯 CPU閾値: 5.0%
💰 高額インスタンス閾値: $100/月
--------------------------------------------------------------------------------
[1/8] 分析中: i-1234567890abcdef0 (web-server-prod) - m5.xlarge
[2/8] 分析中: i-0987654321fedcba0 (database-server) - r5.2xlarge

====================================================================================================
💰 EC2コスト最適化分析結果
====================================================================================================
📊 サマリー:
   分析した実行中インスタンス数: 8
   高額長時間稼働インスタンス: 2
   長期間稼働インスタンス: 3
   潜在的月間節約額: $245.50

🚨 高優先度: 高額長時間稼働インスタンス（24時間以上）
====================================================================================================
インスタンスID        名前                 タイプ          日数     $/月      CPU%     現在コスト   節約額    
----------------------------------------------------------------------------------------------------
i-1234567890abcdef0  web-server-prod     m5.xlarge       45.2     $138      2.1%     $298.50      $149.25    
i-0987654321fedcba0  database-server     r5.2xlarge      72.1     $363      8.5%     $876.20      $0.00      

💡 高額インスタンスの推奨事項:
   - これらの高コストインスタンスが本当に必要かレビューしてください
   - CPU使用率の低いインスタンスのダウンサイジングを検討してください
   - 開発/テスト環境には自動シャットダウンスケジュールを実装してください
   - 長期ワークロードにはリザーブドインスタンスを検討してください

⚠️  中優先度: 長期間稼働インスタンス（30日以上）
====================================================================================================
インスタンスID        名前                 タイプ          日数     $/月      CPU%     現在コスト   節約額    
----------------------------------------------------------------------------------------------------
i-abcdef1234567890   test-environment    t3.large        35.8     $60       1.2%     $71.50       $14.30     
i-fedcba0987654321   dev-server          t3.medium       42.3     $30       15.2%    $52.80       $0.00      
i-567890abcdef1234   backup-server       t3.small        67.2     $15       0.8%     $33.60       $6.72      

💡 長期間稼働インスタンスの推奨事項:
   - 継続的な稼働が必要かレビューしてください
   - 非本番ワークロードにはスケジュール開始/停止を実装してください
   - 障害耐性のあるワークロードにはスポットインスタンスを検討してください
   - 適正サイジングの機会を評価してください

📄 詳細レポートをcost_analysis.jsonに保存しました
====================================================================================================
```

## 🔍 分析基準

### 2段階分析アプローチ

#### 🚨 高優先度: 高額長時間稼働インスタンス
- **基準**: 月額コスト ≥ $100 かつ 稼働時間 ≥ 24時間
- **焦点**: 即座の最適化が可能な高コストインスタンス
- **推奨アクション**: ダウンサイジング、スケジューリング、リザーブドインスタンス

#### ⚠️ 中優先度: 長期間稼働インスタンス  
- **基準**: 稼働時間 ≥ 30日（コストに関係なく）
- **焦点**: 忘れられた、または過剰プロビジョニングされたインスタンス
- **推奨アクション**: 必要性の確認、スケジューリング実装、適正サイジング

### 分析メトリクス
- **CPUUtilization**: 分析期間中の平均CPU使用率
- **NetworkIn/NetworkOut**: ネットワークトラフィック量
- **コスト計算**: 現在のインスタンス料金に基づく（東京リージョン）
- **潜在的節約額**: 最適化アクションによる推定節約額

### 分析対象外
- **停止中インスタンス**: 継続的なコストが発生していないため分析対象外
- **最近起動したインスタンス**: 24時間未満稼働（データ不足）

## ⚠️ 重要な注意事項

- **CloudWatchコスト**: このツールはCloudWatchメトリクスを使用するため料金が発生する場合があります
- **新しいインスタンス**: 24時間未満稼働のインスタンスはメトリクスが不十分な場合があります
- **確認が必要**: インスタンス終了前には必ず用途を確認してください
- **コスト見積もり**: 料金は概算であり、東京リージョンの料金に基づいています

## 🔧 トラブルシューティング

### よくある問題

| 問題 | 解決方法 |
|------|----------|
| **認証エラー** | `aws configure list`で認証情報を確認 |
| **権限拒否** | IAMユーザー/ロールに必要な権限があることを確認 |
| **リージョンが見つからない** | `--region`オプションで正しいリージョンを指定 |
| **Pythonが見つからない** | 管理者権限で`install_python.bat`を実行 |
| **仮想環境の問題** | `venv`フォルダを削除して`setup.bat`を再実行 |

### ヘルプの取得

1. 既知の問題については[Issues](https://github.com/yoshitaka-atarashi/AWS-EC2CostAnalyzer/issues)ページを確認
2. AWS認証情報と権限を確認
3. Python 3.7+がインストールされていることを確認
4. AWSサービスへのネットワーク接続を確認

## 🤝 貢献

貢献を歓迎します！詳細については[貢献ガイドライン](CONTRIBUTING.md)をご覧ください。

### 開発セットアップ

1. リポジトリをフォーク
2. フォークをクローン: `git clone https://github.com/yourusername/AWS-EC2CostAnalyzer.git`
3. `setup.bat`を実行して開発環境を作成
4. 変更を加える
5. 十分にテスト
6. プルリクエストを送信

## 📄 ライセンス

このプロジェクトはMITライセンスの下でライセンスされています - 詳細は[LICENSE](LICENSE)ファイルをご覧ください。

## 🙏 謝辞

- AWS SDK for Python (Boto3) チーム
- CloudWatchメトリクスサービス
- オープンソースコミュニティの貢献者

---

**⭐ このツールがコスト削減に役立った場合は、ぜひスターをお願いします！**